--echo # Check 'ngram_token_size' variable.

--echo #
--echo # It's a global variable.
SELECT @@global.ngram_token_size;
SHOW GLOBAL VARIABLES LIKE 'ngram_token_size';
SELECT * FROM information_schema.global_variables WHERE variable_name='ngram_token_size';

--echo #
--echo # Not a session variable.
--error ER_INCORRECT_GLOBAL_LOCAL_VAR
SELECT @@session.ngram_token_size;
SHOW SESSION VARIABLES LIKE 'ngram_token_size';
SELECT * FROM information_schema.session_variables WHERE variable_name='ngram_token_size';

--let $saved_ngram_token_size= `SELECT @@global.ngram_token_size`

--echo #
--echo # 0 is outside allowed range [1, 10], so it's changed to 1.
SET GLOBAL ngram_token_size= 0;
SELECT * FROM information_schema.global_variables WHERE variable_name='ngram_token_size';

--echo #
--echo # 10 is an acceptable value.
SET GLOBAL ngram_token_size= 10;
SELECT * FROM information_schema.global_variables WHERE variable_name='ngram_token_size';

--echo #
--echo # 1 is an acceptable value.
SET GLOBAL ngram_token_size= 1;
SELECT * FROM information_schema.global_variables WHERE variable_name='ngram_token_size';

--echo #
--echo # 11 is outside allowed range [1, 10], so it's changed to 10.
SET GLOBAL ngram_token_size= 11;
SELECT * FROM information_schema.global_variables WHERE variable_name='ngram_token_size';

--echo #
--echo # Try 3-grams.
SET GLOBAL ngram_token_size= 3;
CREATE TABLE t (str TEXT, FULLTEXT INDEX (str) WITH PARSER ngram) Engine=InnoDB;

INSERT INTO t VALUES
  ('Lorem ipsum dolor sit amet, consectetur adipiscing elit.'),
  ('Maecenas non pellentesque odio.'),
  ('Sed fermentum egestas sapien vel consequat.');

--echo # Only one row contains substring "api".
SELECT str FROM t WHERE MATCH(str) AGAINST('api');

--echo # "lent" is parsed into ("len", "ent") list. Two rows contain at least one of the tokens.
SELECT str FROM t WHERE MATCH(str) AGAINST('lent*');

--echo # "zzz" is not present anywhere, so result is empty.
SELECT str FROM t WHERE MATCH(str) AGAINST('zzzz');

--echo # "piz" cannot be found anywhere, but "api" is in one of the rows.
SELECT str FROM t WHERE MATCH(str) AGAINST('apiz');

--echo #
--echo # Try switching to 2-grams while keeping the index.
SET GLOBAL ngram_token_size= 2;

--echo # "api" is now parsed into ("ap", "pi"). Since index only contains 3-grams, nothing is found.
SELECT str FROM t WHERE MATCH(str) AGAINST('api');

--echo #
--echo # Switching back to 3-grams makes index usable again.
SET GLOBAL ngram_token_size= 3;
SELECT str FROM t WHERE MATCH(str) AGAINST('api');

--echo #
--echo # Try matching in boolean mode.
SELECT str FROM t WHERE MATCH(str) AGAINST('+ent -api' IN BOOLEAN MODE);

--echo #
DROP TABLE t;

# Restore default values.
--disable_query_log
--eval SET GLOBAL ngram_token_size= $saved_ngram_token_size
--enable_query_log
